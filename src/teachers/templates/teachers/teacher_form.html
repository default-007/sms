<!-- teachers/templates/teachers/teacher_form.html - ENHANCED VERSION -->

{% extends "base.html" %}
{% load static %}

{% block title %}{{ title|default:"Teacher Form" }}{% endblock %}

{% block extra_css %}
<style>
  .auto-gen-info {
    background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
    border-left: 4px solid #2196f3;
  }

  .credential-preview {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
  }

  .form-section {
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
  }

  .form-section-header {
    background: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    padding: 1rem;
    border-radius: 0.5rem 0.5rem 0 0;
  }

  .form-section-body {
    padding: 1.5rem;
  }

  .required-field::after {
    content: " *";
    color: #dc3545;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-lg-10 col-md-12 mx-auto">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-chalkboard-teacher me-2"></i>
            {{ title|default:"Teacher Form" }}
          </h4>
          {% if subtitle %}
          <p class="mb-0 mt-2 opacity-75">{{ subtitle }}</p>
          {% endif %}
        </div>

        <div class="card-body">
          <!-- Auto-generation Info Alert (only for creation) -->
          {% if not form.instance.pk %}
          <div class="alert auto-gen-info d-flex align-items-center mb-4" role="alert">
            <i class="fas fa-magic me-3 fs-5"></i>
            <div>
              <strong>Auto-Generation Available:</strong> Leave username, password, and employee ID fields blank
              to automatically generate secure credentials. The teacher will receive an email with their login details.
            </div>
          </div>
          {% endif %}

          <form method="post" enctype="multipart/form-data" id="teacherForm">
            {% csrf_token %}

            <!-- User Information Section -->
            <div class="form-section">
              <div class="form-section-header">
                <h5 class="mb-0">
                  <i class="fas fa-user me-2"></i>Personal Information
                </h5>
              </div>
              <div class="form-section-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.first_name.id_for_label }}" class="form-label required-field">
                      First Name
                    </label>
                    {{ form.first_name }}
                    {% if form.first_name.help_text %}
                    <div class="form-text">{{ form.first_name.help_text }}</div>
                    {% endif %}
                    {% if form.first_name.errors %}
                    <div class="text-danger small">{{ form.first_name.errors.0 }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="{{ form.last_name.id_for_label }}" class="form-label required-field">
                      Last Name
                    </label>
                    {{ form.last_name }}
                    {% if form.last_name.help_text %}
                    <div class="form-text">{{ form.last_name.help_text }}</div>
                    {% endif %}
                    {% if form.last_name.errors %}
                    <div class="text-danger small">{{ form.last_name.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.email.id_for_label }}" class="form-label required-field">
                      Email Address
                    </label>
                    {{ form.email }}
                    {% if form.email.help_text %}
                    <div class="form-text">{{ form.email.help_text }}</div>
                    {% endif %}
                    {% if form.email.errors %}
                    <div class="text-danger small">{{ form.email.errors.0 }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="{{ form.phone_number.id_for_label }}" class="form-label">
                      Phone Number
                    </label>
                    {{ form.phone_number }}
                    {% if form.phone_number.help_text %}
                    <div class="form-text">{{ form.phone_number.help_text }}</div>
                    {% endif %}
                    {% if form.phone_number.errors %}
                    <div class="text-danger small">{{ form.phone_number.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.profile_picture.id_for_label }}" class="form-label">
                      Profile Picture
                    </label>
                    {{ form.profile_picture }}
                    {% if form.profile_picture.help_text %}
                    <div class="form-text">{{ form.profile_picture.help_text }}</div>
                    {% endif %}
                    {% if form.profile_picture.errors %}
                    <div class="text-danger small">{{ form.profile_picture.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Account Credentials Section (only for creation) -->
            {% if not form.instance.pk %}
            <div class="form-section">
              <div class="form-section-header">
                <h5 class="mb-0">
                  <i class="fas fa-key me-2"></i>Account Credentials
                  <button type="button" class="btn btn-outline-info btn-sm ms-2" id="previewBtn">
                    <i class="fas fa-eye me-1"></i>Preview Auto-Generated
                  </button>
                </h5>
              </div>
              <div class="form-section-body">
                <div class="alert alert-info" role="alert">
                  <i class="fas fa-info-circle me-2"></i>
                  <strong>Recommended:</strong> Leave these fields blank for automatic generation of secure credentials.
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.username.id_for_label }}" class="form-label">
                      Username
                      <i class="fas fa-question-circle text-muted ms-1" title="Auto-generated from name if left blank"
                        data-bs-toggle="tooltip"></i>
                    </label>
                    {{ form.username }}
                    {% if form.username.help_text %}
                    <div class="form-text">{{ form.username.help_text }}</div>
                    {% endif %}
                    {% if form.username.errors %}
                    <div class="text-danger small">{{ form.username.errors.0 }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="{{ form.employee_id.id_for_label }}" class="form-label">
                      Employee ID
                      <i class="fas fa-question-circle text-muted ms-1"
                        title="Auto-generated in format TCH2025XXXX if left blank" data-bs-toggle="tooltip"></i>
                    </label>
                    {{ form.employee_id }}
                    {% if form.employee_id.help_text %}
                    <div class="form-text">{{ form.employee_id.help_text }}</div>
                    {% endif %}
                    {% if form.employee_id.errors %}
                    <div class="text-danger small">{{ form.employee_id.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.password.id_for_label }}" class="form-label">
                      Password
                      <i class="fas fa-question-circle text-muted ms-1"
                        title="Auto-generated secure password if left blank" data-bs-toggle="tooltip"></i>
                    </label>
                    {{ form.password }}
                    {% if form.password.help_text %}
                    <div class="form-text">{{ form.password.help_text }}</div>
                    {% endif %}
                    {% if form.password.errors %}
                    <div class="text-danger small">{{ form.password.errors.0 }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="{{ form.confirm_password.id_for_label }}" class="form-label">
                      Confirm Password
                    </label>
                    {{ form.confirm_password }}
                    {% if form.confirm_password.errors %}
                    <div class="text-danger small">{{ form.confirm_password.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <!-- Credential Preview Box -->
                <div class="row">
                  <div class="col-12 mb-3">
                    <div id="credentialPreview" class="credential-preview p-3" style="display: none;">
                      <h6><i class="fas fa-eye me-2"></i>Auto-Generated Credentials Preview</h6>
                      <div id="previewContent">
                        <!-- Populated by JavaScript -->
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-12 mb-3">
                    <div class="form-check">
                      {{ form.send_welcome_email }}
                      <label class="form-check-label" for="{{ form.send_welcome_email.id_for_label }}">
                        {{ form.send_welcome_email.label }}
                      </label>
                      <div class="form-text">{{ form.send_welcome_email.help_text }}</div>
                      {% if form.send_welcome_email.errors %}
                      <div class="text-danger small">{{ form.send_welcome_email.errors.0 }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Professional Information Section -->
            <div class="form-section">
              <div class="form-section-header">
                <h5 class="mb-0">
                  <i class="fas fa-briefcase me-2"></i>Professional Information
                </h5>
              </div>
              <div class="form-section-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.joining_date.id_for_label }}" class="form-label required-field">
                      Joining Date
                    </label>
                    {{ form.joining_date }}
                    {% if form.joining_date.errors %}
                    <div class="text-danger small">{{ form.joining_date.errors.0 }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="{{ form.department.id_for_label }}" class="form-label">
                      Department
                    </label>
                    {{ form.department }}
                    {% if form.department.errors %}
                    <div class="text-danger small">{{ form.department.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.position.id_for_label }}" class="form-label">
                      Position
                    </label>
                    {{ form.position }}
                    {% if form.position.errors %}
                    <div class="text-danger small">{{ form.position.errors.0 }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="{{ form.experience_years.id_for_label }}" class="form-label">
                      Experience (Years)
                    </label>
                    {{ form.experience_years }}
                    {% if form.experience_years.errors %}
                    <div class="text-danger small">{{ form.experience_years.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.qualification.id_for_label }}" class="form-label">
                      Qualification
                    </label>
                    {{ form.qualification }}
                    {% if form.qualification.errors %}
                    <div class="text-danger small">{{ form.qualification.errors.0 }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="{{ form.salary.id_for_label }}" class="form-label">
                      Salary
                    </label>
                    {{ form.salary }}
                    {% if form.salary.errors %}
                    <div class="text-danger small">{{ form.salary.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.contract_type.id_for_label }}" class="form-label">
                      Contract Type
                    </label>
                    {{ form.contract_type }}
                    {% if form.contract_type.errors %}
                    <div class="text-danger small">{{ form.contract_type.errors.0 }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="{{ form.status.id_for_label }}" class="form-label">
                      Status
                    </label>
                    {{ form.status }}
                    {% if form.status.errors %}
                    <div class="text-danger small">{{ form.status.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.specialization.id_for_label }}" class="form-label">
                      Specialization
                    </label>
                    {{ form.specialization }}
                    {% if form.specialization.errors %}
                    <div class="text-danger small">{{ form.specialization.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12 mb-3">
                    <label for="{{ form.bio.id_for_label }}" class="form-label">
                      Bio
                    </label>
                    {{ form.bio }}
                    {% if form.bio.errors %}
                    <div class="text-danger small">{{ form.bio.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Emergency Contact Section -->
            <div class="form-section">
              <div class="form-section-header">
                <h5 class="mb-0">
                  <i class="fas fa-phone me-2"></i>Emergency Contact
                </h5>
              </div>
              <div class="form-section-body">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label for="{{ form.emergency_contact.id_for_label }}" class="form-label">
                      Emergency Contact Name
                    </label>
                    {{ form.emergency_contact }}
                    {% if form.emergency_contact.errors %}
                    <div class="text-danger small">{{ form.emergency_contact.errors.0 }}</div>
                    {% endif %}
                  </div>

                  <div class="col-md-6 mb-3">
                    <label for="{{ form.emergency_phone.id_for_label }}" class="form-label">
                      Emergency Phone
                    </label>
                    {{ form.emergency_phone }}
                    {% if form.emergency_phone.errors %}
                    <div class="text-danger small">{{ form.emergency_phone.errors.0 }}</div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>

            <!-- Submit Buttons -->
            <div class="row">
              <div class="col-12">
                <div class="d-flex gap-2">
                  <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save me-2"></i>
                    {% if form.instance.pk %}Update Teacher{% else %}Create Teacher{% endif %}
                  </button>
                  <a href="{% url 'teachers:teacher-list' %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-2"></i>
                    Cancel
                  </a>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Form validation and preview functionality
    const form = document.getElementById('teacherForm');
    const firstNameField = document.getElementById('{{ form.first_name.id_for_label }}');
    const lastNameField = document.getElementById('{{ form.last_name.id_for_label }}');
    const emailField = document.getElementById('{{ form.email.id_for_label }}');
    const previewBtn = document.getElementById('previewBtn');
    const credentialPreview = document.getElementById('credentialPreview');
    const previewContent = document.getElementById('previewContent');

    // Preview functionality (only for creation)
    {% if not form.instance.pk %}
    if (previewBtn) {
      previewBtn.addEventListener('click', function () {
        const firstName = firstNameField.value.trim();
        const lastName = lastNameField.value.trim();
        const email = emailField.value.trim();

        if (!firstName || !lastName) {
          alert('Please enter first name and last name to preview credentials.');
          return;
        }

        // Show loading
        previewContent.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating preview...';
        credentialPreview.style.display = 'block';

        // Make AJAX request to get preview
        fetch('{% url "teachers:credential-preview" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: new URLSearchParams({
            'first_name': firstName,
            'last_name': lastName,
            'email': email
          })
        })
          .then(response => response.json())
          .then(data => {
            if (data.error) {
              previewContent.innerHTML = `<div class="text-danger">${data.error}</div>`;
            } else {
              previewContent.innerHTML = `
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Username:</strong><br>
                                <code>${data.username}</code>
                            </div>
                            <div class="col-md-4">
                                <strong>Employee ID:</strong><br>
                                <code>${data.employee_id}</code>
                            </div>
                            <div class="col-md-4">
                                <strong>Password:</strong><br>
                                <small class="text-muted">${data.password_info}</small>
                            </div>
                        </div>
                    `;
            }
          })
          .catch(error => {
            previewContent.innerHTML = '<div class="text-danger">Error loading preview</div>';
            console.error('Preview error:', error);
          });
      });
    }

    // Form submission confirmation for auto-generation
    form.addEventListener('submit', function (e) {
      const username = document.getElementById('{{ form.username.id_for_label }}');
      const password = document.getElementById('{{ form.password.id_for_label }}');
      const employeeId = document.getElementById('{{ form.employee_id.id_for_label }}');

      if (username && password && employeeId &&
        !username.value && !password.value && !employeeId.value) {
        const confirmed = confirm(
          'Username, password, and employee ID will be auto-generated. The teacher will receive an email with their login credentials. Continue?'
        );
        if (!confirmed) {
          e.preventDefault();
        }
      }
    });

    // Password confirmation logic
    const passwordField = document.getElementById('{{ form.password.id_for_label }}');
    const confirmPasswordField = document.getElementById('{{ form.confirm_password.id_for_label }}');
    const emailCheckbox = document.getElementById('{{ form.send_welcome_email.id_for_label }}');

    if (passwordField && confirmPasswordField) {
      const validatePasswords = () => {
        if (passwordField.value && confirmPasswordField.value) {
          if (passwordField.value !== confirmPasswordField.value) {
            confirmPasswordField.setCustomValidity('Passwords do not match');
          } else {
            confirmPasswordField.setCustomValidity('');
          }
        } else {
          confirmPasswordField.setCustomValidity('');
        }
      };

      passwordField.addEventListener('input', validatePasswords);
      confirmPasswordField.addEventListener('input', validatePasswords);

      // Toggle email notification based on manual password setting
      passwordField.addEventListener('input', function () {
        if (emailCheckbox) {
          if (this.value.trim()) {
            emailCheckbox.checked = false;
            showPasswordWarning();
          } else {
            emailCheckbox.checked = true;
            hidePasswordWarning();
          }
        }
      });
    }

    function showPasswordWarning() {
      let warning = document.getElementById('password-warning');
      if (!warning) {
        warning = document.createElement('div');
        warning.id = 'password-warning';
        warning.className = 'alert alert-warning mt-2';
        warning.innerHTML = '<i class="fas fa-exclamation-triangle"></i> You\'ve set a manual password. Consider providing the credentials to the teacher separately.';
        passwordField.parentNode.appendChild(warning);
      }
    }

    function hidePasswordWarning() {
      const warning = document.getElementById('password-warning');
      if (warning) {
        warning.remove();
      }
    }
    {% endif %}
  });
</script>
{% endblock %}