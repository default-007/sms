<!-- students/templates/students/student_form.html -->
{% extends 'base.html' %}
{% load static %}
{% load student_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<link rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css">
<style>
  .required-field::after {
    content: " *";
    color: red;
  }

  .optional-field::after {
    content: " (optional)";
    color: #6c757d;
    font-size: 0.875em;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">{{ title }}</h2>
          <p class="text-muted mb-0">Fill in the student information below</p>
        </div>
        <div>
          <a href="{% url 'students:student-list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Students
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Main Form -->
    <div class="col-lg-8">
      <form method="post" enctype="multipart/form-data" id="studentForm">
        {% csrf_token %}

        <!-- Personal Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">
              <i class="fas fa-user me-2"></i>Personal Information
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.first_name.id_for_label }}" class="form-label required-field">
                    First Name
                  </label>
                  {{ form.first_name }}
                  {% if form.first_name.errors %}
                  <div class="text-danger small">{{ form.first_name.errors }}</div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.last_name.id_for_label }}" class="form-label required-field">
                    Last Name
                  </label>
                  {{ form.last_name }}
                  {% if form.last_name.errors %}
                  <div class="text-danger small">{{ form.last_name.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.email.id_for_label }}" class="form-label optional-field">
                    Email Address
                  </label>
                  {{ form.email }}
                  <div class="form-text">Optional - for login and communication</div>
                  {% if form.email.errors %}
                  <div class="text-danger small">{{ form.email.errors }}</div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.phone_number.id_for_label }}" class="form-label optional-field">
                    Phone Number
                  </label>
                  {{ form.phone_number }}
                  <div class="form-text">Optional - for contact purposes</div>
                  {% if form.phone_number.errors %}
                  <div class="text-danger small">{{ form.phone_number.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.date_of_birth.id_for_label }}" class="form-label optional-field">
                    Date of Birth
                  </label>
                  {{ form.date_of_birth }}
                  {% if form.date_of_birth.errors %}
                  <div class="text-danger small">{{ form.date_of_birth.errors }}</div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.gender.id_for_label }}" class="form-label optional-field">
                    Gender
                  </label>
                  {{ form.gender }}
                  {% if form.gender.errors %}
                  <div class="text-danger small">{{ form.gender.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Academic Information -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">
              <i class="fas fa-graduation-cap me-2"></i>Academic Information
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.admission_number.id_for_label }}" class="form-label required-field">
                    Admission Number
                  </label>
                  {{ form.admission_number }}
                  <div class="form-text">Will be used as username for login</div>
                  {% if form.admission_number.errors %}
                  <div class="text-danger small">{{ form.admission_number.errors }}</div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.admission_date.id_for_label }}" class="form-label required-field">
                    Admission Date
                  </label>
                  {{ form.admission_date }}
                  {% if form.admission_date.errors %}
                  <div class="text-danger small">{{ form.admission_date.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.current_class.id_for_label }}" class="form-label optional-field">
                    Current Class
                  </label>
                  {{ form.current_class }}
                  {% if form.current_class.errors %}
                  <div class="text-danger small">{{ form.current_class.errors }}</div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.roll_number.id_for_label }}" class="form-label optional-field">
                    Roll Number
                  </label>
                  {{ form.roll_number }}
                  {% if form.roll_number.errors %}
                  <div class="text-danger small">{{ form.roll_number.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Emergency Contact -->
        <div class="card mb-4">
          <div class="card-header">
            <h6 class="card-title mb-0">
              <i class="fas fa-phone me-2"></i>Emergency Contact
            </h6>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.emergency_contact_name.id_for_label }}" class="form-label required-field">
                    Emergency Contact Name
                  </label>
                  {{ form.emergency_contact_name }}
                  {% if form.emergency_contact_name.errors %}
                  <div class="text-danger small">{{ form.emergency_contact_name.errors }}</div>
                  {% endif %}
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="{{ form.emergency_contact_number.id_for_label }}" class="form-label required-field">
                    Emergency Contact Number
                  </label>
                  {{ form.emergency_contact_number }}
                  {% if form.emergency_contact_number.errors %}
                  <div class="text-danger small">{{ form.emergency_contact_number.errors }}</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Submit Button -->
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between">
              <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                <i class="fas fa-times me-2"></i>Cancel
              </button>
              <button type="submit" class="btn btn-primary" id="submitBtn">
                <i class="fas fa-save me-2"></i>{{ button_label|default:"Save Student" }}
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Form Progress -->
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0">Form Completion</h6>
        </div>
        <div class="card-body">
          <div class="progress mb-2">
            <div class="progress-bar" id="formProgress" style="width: 0%"></div>
          </div>
          <div class="d-flex justify-content-between">
            <small>Required fields</small>
            <small id="progressText">0%</small>
          </div>
          <div class="mt-3">
            <h6>Required Fields:</h6>
            <ul class="list-unstyled small" id="requiredFieldsList">
              <li><i class="fas fa-square text-muted me-2"></i>First Name</li>
              <li><i class="fas fa-square text-muted me-2"></i>Last Name</li>
              <li><i class="fas fa-square text-muted me-2"></i>Admission Number</li>
              <li><i class="fas fa-square text-muted me-2"></i>Admission Date</li>
              <li><i class="fas fa-square text-muted me-2"></i>Emergency Contact Name</li>
              <li><i class="fas fa-square text-muted me-2"></i>Emergency Contact Number</li>
            </ul>
            <h6 class="mt-3">Optional Fields:</h6>
            <ul class="list-unstyled small text-muted">
              <li><i class="fas fa-circle text-muted me-2"></i>Email Address</li>
              <li><i class="fas fa-circle text-muted me-2"></i>Phone Number</li>
              <li><i class="fas fa-circle text-muted me-2"></i>Date of Birth</li>
              <li><i class="fas fa-circle text-muted me-2"></i>Current Class</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function () {
    // Form validation and progress tracking
    updateFormProgress();

    // Update progress on field changes
    $('input, select, textarea').on('input change', function () {
      updateFormProgress();
    });

    // Form submission with validation
    $('#studentForm').on('submit', function (e) {
      if (!validateForm()) {
        e.preventDefault();
        showValidationErrors();
      } else {
        // Show loading state
        $('button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Saving...');
      }
    });

    // Real-time field validation
    $('.form-control').on('blur', function () {
      validateField($(this));
    });
  });

  function updateFormProgress() {
    // UPDATED: Only check required fields, email and phone are optional
    const requiredFields = [
      '#{{ form.first_name.id_for_label }}',
      '#{{ form.last_name.id_for_label }}',
      '#{{ form.admission_number.id_for_label }}',
      '#{{ form.admission_date.id_for_label }}',
      '#{{ form.emergency_contact_name.id_for_label }}',
      '#{{ form.emergency_contact_number.id_for_label }}'
    ];

    let filledCount = 0;
    const totalRequired = requiredFields.length;

    // Clear previous validation states
    $('.is-invalid').removeClass('is-invalid');

    requiredFields.forEach(fieldId => {
      const field = $(fieldId);
      const listItem = $(`#requiredFieldsList li:eq(${requiredFields.indexOf(fieldId)})`);

      if (field.val() && field.val().trim() !== '') {
        filledCount++;
        listItem.find('i').removeClass('text-muted').addClass('text-success').removeClass('fa-square').addClass('fa-check-square');
      } else {
        listItem.find('i').removeClass('text-success').addClass('text-muted').removeClass('fa-check-square').addClass('fa-square');
      }
    });

    const percentage = Math.round((filledCount / totalRequired) * 100);
    $('#formProgress').css('width', percentage + '%');
    $('#progressText').text(percentage + '%');

    // Update progress bar color
    if (percentage === 100) {
      $('#formProgress').removeClass('bg-danger bg-warning').addClass('bg-success');
    } else if (percentage >= 50) {
      $('#formProgress').removeClass('bg-danger bg-success').addClass('bg-warning');
    } else {
      $('#formProgress').removeClass('bg-warning bg-success').addClass('bg-danger');
    }
  }

  function validateForm() {
    let isValid = true;

    // UPDATED: Only validate required fields
    const requiredFields = [
      '#{{ form.first_name.id_for_label }}',
      '#{{ form.last_name.id_for_label }}',
      '#{{ form.admission_number.id_for_label }}',
      '#{{ form.admission_date.id_for_label }}',
      '#{{ form.emergency_contact_name.id_for_label }}',
      '#{{ form.emergency_contact_number.id_for_label }}'
    ];

    // Clear previous validation states
    $('.is-invalid').removeClass('is-invalid');

    requiredFields.forEach(fieldId => {
      const field = $(fieldId);
      if (!field.val() || field.val().trim() === '') {
        field.addClass('is-invalid');
        isValid = false;
      }
    });

    // Validate email format only if provided
    const email = $('#{{ form.email.id_for_label }}').val();
    if (email && !isValidEmail(email)) {
      $('#{{ form.email.id_for_label }}').addClass('is-invalid');
      isValid = false;
    }

    // Validate password confirmation if passwords are provided
    const password = $('#{{ form.password.id_for_label }}').val();
    const confirmPassword = $('#{{ form.confirm_password.id_for_label }}').val();
    if (password && confirmPassword && password !== confirmPassword) {
      $('#{{ form.confirm_password.id_for_label }}').addClass('is-invalid');
      isValid = false;
    }

    return isValid;
  }

  function validateField(field) {
    const fieldId = field.attr('id');
    const value = field.val().trim();

    // Required field validation
    const requiredFields = [
      '{{ form.first_name.id_for_label }}',
      '{{ form.last_name.id_for_label }}',
      '{{ form.admission_number.id_for_label }}',
      '{{ form.admission_date.id_for_label }}',
      '{{ form.emergency_contact_name.id_for_label }}',
      '{{ form.emergency_contact_number.id_for_label }}'
    ];

    if (requiredFields.includes(fieldId)) {
      if (!value) {
        field.addClass('is-invalid');
        return false;
      } else {
        field.removeClass('is-invalid').addClass('is-valid');
      }
    }

    // Email validation only if provided
    if (fieldId === '{{ form.email.id_for_label }}' && value) {
      if (!isValidEmail(value)) {
        field.addClass('is-invalid');
        return false;
      } else {
        field.removeClass('is-invalid').addClass('is-valid');
      }
    }

    // Phone validation only if provided
    if (fieldId === '{{ form.phone_number.id_for_label }}' && value) {
      if (!isValidPhone(value)) {
        field.addClass('is-invalid');
        return false;
      } else {
        field.removeClass('is-invalid').addClass('is-valid');
      }
    }

    updateFormProgress();
    return true;
  }

  function showValidationErrors() {
    const firstInvalidField = $('.is-invalid').first();
    if (firstInvalidField.length) {
      $('html, body').animate({
        scrollTop: firstInvalidField.offset().top - 100
      }, 500);
      firstInvalidField.focus();
    }
  }

  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function isValidPhone(phone) {
    const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
    return phoneRegex.test(phone.replace(/\s/g, ''));
  }
</script>
{% endblock %}