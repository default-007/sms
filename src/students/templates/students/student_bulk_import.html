<!-- templates/students/student_bulk_import.html -->
{% extends 'base.html' %}
{% load static %}
{% load student_tags %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<style>
  .import-steps {
    counter-reset: step-counter;
  }

  .import-step {
    counter-increment: step-counter;
    position: relative;
    padding-left: 50px;
    margin-bottom: 2rem;
  }

  .import-step::before {
    content: counter(step-counter);
    position: absolute;
    left: 0;
    top: 0;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
  }

  .class-info-card {
    border-left: 4px solid #007bff;
    background: linear-gradient(135deg, #f8f9ff, #ffffff);
  }

  .capacity-bar {
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
  }

  .capacity-fill {
    height: 100%;
    transition: width 0.3s ease;
  }

  .dropzone {
    border: 2px dashed #007bff;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    background: linear-gradient(135deg, #f8f9ff, #ffffff);
  }

  .dropzone:hover {
    border-color: #0056b3;
    background: linear-gradient(135deg, #e7f0ff, #f8f9ff);
  }

  .dropzone.dragover {
    border-color: #28a745;
    background: linear-gradient(135deg, #e8f5e8, #f0fff0);
  }

  .template-tip {
    border-left: 4px solid #28a745;
    background: linear-gradient(135deg, #f8fff8, #ffffff);
  }

  .form-section {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    border: 1px solid #e9ecef;
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">
            <i class="fas fa-upload me-2 text-primary"></i>{{ title }}
          </h2>
          <p class="text-muted mb-0">{{ description }}</p>
        </div>
        <div>
          <a href="{% url 'students:student-list' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Students
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
      <div class="import-steps">

        <!-- Step 1: Class Selection -->
        <div class="import-step">
          <div class="form-section">
            <div class="card-header bg-primary text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-users me-2"></i>Step 1: Choose Import Method
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="form-check form-check-custom mb-3">
                    <input class="form-check-input" type="radio" name="import_method" id="method_per_class"
                      value="per_class" checked>
                    <label class="form-check-label" for="method_per_class">
                      <strong>Per-Class Import</strong>
                      <br><small class="text-muted">Import all students to a specific class</small>
                    </label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check form-check-custom mb-3">
                    <input class="form-check-input" type="radio" name="import_method" id="method_mixed" value="mixed">
                    <label class="form-check-label" for="method_mixed">
                      <strong>Mixed Classes Import</strong>
                      <br><small class="text-muted">Use class_id column in CSV for different classes</small>
                    </label>
                  </div>
                </div>
              </div>

              <!-- Class Selection Form -->
              <form method="post" enctype="multipart/form-data" id="importForm">
                {% csrf_token %}

                <div class="row" id="class_selection_section">
                  <div class="col-md-6">
                    <label for="{{ form.target_class.id_for_label }}" class="form-label">
                      <i class="fas fa-chalkboard me-1"></i>Target Class
                    </label>
                    {{ form.target_class }}
                    <div class="form-text">{{ form.target_class.help_text }}</div>
                  </div>
                  <div class="col-md-6">
                    <label for="{{ form.academic_year.id_for_label }}" class="form-label">
                      <i class="fas fa-calendar me-1"></i>Academic Year
                    </label>
                    {{ form.academic_year }}
                    <div class="form-text">{{ form.academic_year.help_text }}</div>
                  </div>
                </div>

                <!-- Class Information Display -->
                <div id="class_info_display" class="mt-3" style="display: none;">
                  <div class="class-info-card p-3 rounded">
                    <h6 class="text-primary mb-2">
                      <i class="fas fa-info-circle me-1"></i>Selected Class Information
                    </h6>
                    <div class="row">
                      <div class="col-md-6">
                        <small class="text-muted">Class:</small>
                        <div class="fw-bold" id="class_display_name">-</div>
                      </div>
                      <div class="col-md-6">
                        <small class="text-muted">Room:</small>
                        <div id="class_room_number">-</div>
                      </div>
                      <div class="col-md-6 mt-2">
                        <small class="text-muted">Current Students:</small>
                        <div id="class_current_students">-</div>
                      </div>
                      <div class="col-md-6 mt-2">
                        <small class="text-muted">Available Spots:</small>
                        <div id="class_available_spots">-</div>
                      </div>
                      <div class="col-12 mt-2">
                        <small class="text-muted">Capacity Utilization:</small>
                        <div class="capacity-bar mt-1">
                          <div class="capacity-fill bg-primary" id="capacity_fill" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="capacity_percentage">0%</small>
                      </div>
                    </div>
                  </div>
                </div>

            </div>
          </div>
        </div>

        <!-- Step 2: Download Template -->
        <div class="import-step">
          <div class="form-section">
            <div class="card-header bg-success text-white">
              <h5 class="card-title mb-0">
                <i class="fas fa-download me-2"></i>Step 2: Download Template
              </h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-8">
                  <p class="mb-3">Download the CSV template and fill in your student data.</p>

                  <div class="d-flex gap-2 mb-4">
                    <a href="{% url 'students:download-template' 'students' %}" class="btn btn-success">
                      <i class="fas fa-download me-2"></i>Download Template
                    </a>
                    <button type="button" class="btn btn-outline-info" data-bs-toggle="modal"
                      data-bs-target="#templatePreviewModal">
                      <i class="fas fa-eye me-2"></i>Preview Template
                    </button>
                  </div>

                  <!-- Required Fields -->
                  <div class="alert alert-info">
                    <h6 class="alert-heading">
                      <i class="fas fa-exclamation-circle me-2"></i>Required Fields
                    </h6>
                    <div class="row">
                      <div class="col-md-6">
                        <ul class="mb-0 small">
                          <li><strong>first_name</strong> - Student's first name</li>
                          <li><strong>last_name</strong> - Student's last name</li>
                          <li><strong>admission_number</strong> - Unique identifier</li>
                        </ul>
                      </div>
                      <div class="col-md-6">
                        <ul class="mb-0 small">
                          <li><em>email</em> - Optional, for notifications</li>
                          <li><em>class_id</em> - Optional, for mixed class import</li>
                          <li><em>emergency contacts</em> - Recommended</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <!-- Template Tips -->
                  {% for tip in template_tips %}
                  <div class="template-tip p-3 rounded mb-2">
                    <div class="d-flex">
                      <i class="{{ tip.icon }} text-success me-2 mt-1"></i>
                      <div>
                        <h6 class="mb-1">{{ tip.title }}</h6>
                        <small class="text-muted">{{ tip.description }}</small>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Step 3: Upload File -->
        <div class="import-step">
          <div class="form-section">
            <div class="card-header bg-warning text-dark">
              <h5 class="card-title mb-0">
                <i class="fas fa-cloud-upload-alt me-2"></i>Step 3: Upload CSV File
              </h5>
            </div>
            <div class="card-body">

              <!-- File Upload -->
              <div class="mb-4">
                <label for="{{ form.csv_file.id_for_label }}" class="form-label">
                  <i class="fas fa-file-csv me-1"></i>CSV File <span class="text-danger">*</span>
                </label>
                <div class="dropzone" id="csvDropzone">
                  <div class="dz-message">
                    <div class="display-4 text-muted mb-3">
                      <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h5>Drop CSV file here or click to browse</h5>
                    <p class="text-muted">Maximum file size: 5MB</p>
                  </div>
                </div>
                {{ form.csv_file }}
                {% if form.csv_file.errors %}
                <div class="text-danger small mt-2">{{ form.csv_file.errors }}</div>
                {% endif %}
              </div>

              <!-- Import Options -->
              <div class="row mb-4">
                <div class="col-md-4">
                  <div class="form-check form-switch">
                    {{ form.auto_assign_class }}
                    <label for="{{ form.auto_assign_class.id_for_label }}" class="form-check-label">
                      Auto-assign to Target Class
                    </label>
                    <div class="form-text">{{ form.auto_assign_class.help_text }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check form-switch">
                    {{ form.send_email_notifications }}
                    <label for="{{ form.send_email_notifications.id_for_label }}" class="form-check-label">
                      Send Email Notifications
                    </label>
                    <div class="form-text">{{ form.send_email_notifications.help_text }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="form-check form-switch">
                    {{ form.update_existing }}
                    <label for="{{ form.update_existing.id_for_label }}" class="form-check-label">
                      Update Existing Students
                    </label>
                    <div class="form-text">{{ form.update_existing.help_text }}</div>
                  </div>
                </div>
              </div>

              <!-- Submit Button -->
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-outline-secondary" onclick="window.history.back()">
                  <i class="fas fa-arrow-left me-2"></i>Cancel
                </button>
                <button type="submit" class="btn btn-primary" id="importBtn" disabled>
                  <i class="fas fa-upload me-2"></i>Import Students
                </button>
              </div>

              </form>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Important Notes -->
      <div class="card mb-4">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i class="fas fa-lightbulb me-2 text-warning"></i>Important Notes
          </h6>
        </div>
        <div class="card-body">
          <ul class="mb-0 small">
            {% for note in important_notes %}
            <li class="mb-2">{{ note }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <!-- Available Classes -->
      {% if available_classes %}
      <div class="card">
        <div class="card-header">
          <h6 class="card-title mb-0">
            <i class="fas fa-chalkboard-teacher me-2"></i>Available Classes
          </h6>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-sm mb-0">
              <thead class="table-light">
                <tr>
                  <th>Class</th>
                  <th>Students</th>
                  <th>Capacity</th>
                </tr>
              </thead>
              <tbody>
                {% for class in available_classes %}
                <tr>
                  <td>
                    <small>{{ class.name }}</small>
                  </td>
                  <td>
                    <small>{{ class.current_students }}</small>
                  </td>
                  <td>
                    <small>{{ class.capacity }}</small>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Template Preview Modal -->
<div class="modal fade" id="templatePreviewModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">CSV Template Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table table-sm table-bordered">
            <thead class="table-dark">
              <tr>
                {% for header in csv_template_headers %}
                <th style="min-width: 120px;">{{ header }}</th>
                {% endfor %}
              </tr>
            </thead>
            <tbody>
              {% for sample in csv_sample_data %}
              <tr>
                {% for header in csv_template_headers %}
                <td>
                  <small>{{ sample|dict_get:header|default:"-" }}</small>
                </td>
                {% endfor %}
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const importMethodRadios = document.querySelectorAll('input[name="import_method"]');
    const classSelectionSection = document.getElementById('class_selection_section');
    const targetClassSelect = document.getElementById('{{ form.target_class.id_for_label }}');
    const autoAssignCheckbox = document.getElementById('{{ form.auto_assign_class.id_for_label }}');
    const classInfoDisplay = document.getElementById('class_info_display');
    const csvFileInput = document.getElementById('{{ form.csv_file.id_for_label }}');
    const importBtn = document.getElementById('importBtn');

    // Handle import method change
    importMethodRadios.forEach(radio => {
      radio.addEventListener('change', function () {
        if (this.value === 'per_class') {
          classSelectionSection.style.display = 'block';
          autoAssignCheckbox.checked = true;
          targetClassSelect.required = true;
        } else {
          classSelectionSection.style.display = 'none';
          autoAssignCheckbox.checked = false;
          targetClassSelect.required = false;
          classInfoDisplay.style.display = 'none';
        }
        updateImportButton();
      });
    });

    // Handle class selection change
    targetClassSelect.addEventListener('change', function () {
      if (this.value) {
        fetchClassInfo(this.value);
      } else {
        classInfoDisplay.style.display = 'none';
      }
      updateImportButton();
    });

    // Handle file selection
    csvFileInput.addEventListener('change', function () {
      updateImportButton();
    });

    // Fetch class information
    function fetchClassInfo(classId) {
      fetch(`/api/classes/${classId}/info/`)
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            displayClassInfo(data.class_info);
          }
        })
        .catch(error => {
          console.error('Error fetching class info:', error);
        });
    }

    // Display class information
    function displayClassInfo(classInfo) {
      document.getElementById('class_display_name').textContent = classInfo.full_name;
      document.getElementById('class_room_number').textContent = classInfo.room_number;
      document.getElementById('class_current_students').textContent = classInfo.current_students;
      document.getElementById('class_available_spots').textContent = classInfo.available_spots;
      document.getElementById('capacity_percentage').textContent = classInfo.utilization_percentage + '%';

      const capacityFill = document.getElementById('capacity_fill');
      capacityFill.style.width = classInfo.utilization_percentage + '%';

      // Change color based on utilization
      if (classInfo.utilization_percentage > 90) {
        capacityFill.className = 'capacity-fill bg-danger';
      } else if (classInfo.utilization_percentage > 75) {
        capacityFill.className = 'capacity-fill bg-warning';
      } else {
        capacityFill.className = 'capacity-fill bg-success';
      }

      classInfoDisplay.style.display = 'block';
    }

    // Update import button state
    function updateImportButton() {
      const hasFile = csvFileInput.files.length > 0;
      const methodPerClass = document.getElementById('method_per_class').checked;
      const hasTargetClass = targetClassSelect.value !== '';

      let canImport = hasFile;

      if (methodPerClass) {
        canImport = canImport && hasTargetClass;
      }

      importBtn.disabled = !canImport;
    }

    // Initialize dropzone functionality
    const dropzone = document.getElementById('csvDropzone');

    dropzone.addEventListener('dragover', function (e) {
      e.preventDefault();
      this.classList.add('dragover');
    });

    dropzone.addEventListener('dragleave', function (e) {
      e.preventDefault();
      this.classList.remove('dragover');
    });

    dropzone.addEventListener('drop', function (e) {
      e.preventDefault();
      this.classList.remove('dragover');

      const files = e.dataTransfer.files;
      if (files.length > 0 && files[0].name.endsWith('.csv')) {
        csvFileInput.files = files;
        updateImportButton();
      }
    });

    dropzone.addEventListener('click', function () {
      csvFileInput.click();
    });

    // Initial state
    updateImportButton();
  });
</script>
{% endblock %}