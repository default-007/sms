{% extends 'dashboard_base.html' %}

{% block title %}Dashboard | School Management System{% endblock %}

{% block page_title %}Dashboard{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block dashboard_content %}
<div x-data="dashboardData()">
  <!-- Stats Cards -->
  <div class="row">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-body stats-card primary">
          <div class="stats-card-content">
            <div>
              <div class="stats-card-title">Total Students</div>
              <h4 class="stats-card-value" x-text="formatNumber(totalStudents)"></h4>
              <div class="small" x-show="studentGrowth > 0">
                <i class="fas fa-arrow-up text-success me-1"></i>
                <span x-text="studentGrowth + '%'"></span> since last month
              </div>
              <div class="small" x-show="studentGrowth < 0">
                <i class="fas fa-arrow-down text-danger me-1"></i>
                <span x-text="Math.abs(studentGrowth) + '%'"></span> since last month
              </div>
              <div class="small" x-show="studentGrowth === 0">
                <i class="fas fa-equals text-muted me-1"></i>
                No change since last month
              </div>
            </div>
            <div class="stats-card-icon">
              <i class="fas fa-user-graduate"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-body stats-card success">
          <div class="stats-card-content">
            <div>
              <div class="stats-card-title">Attendance Rate</div>
              <h4 class="stats-card-value" x-text="attendanceRate + '%'"></h4>
              <div class="small" x-show="attendanceGrowth > 0">
                <i class="fas fa-arrow-up text-success me-1"></i>
                <span x-text="attendanceGrowth + '%'"></span> since last month
              </div>
              <div class="small" x-show="attendanceGrowth < 0">
                <i class="fas fa-arrow-down text-danger me-1"></i>
                <span x-text="Math.abs(attendanceGrowth) + '%'"></span> since last month
              </div>
              <div class="small" x-show="attendanceGrowth === 0">
                <i class="fas fa-equals text-muted me-1"></i>
                No change since last month
              </div>
            </div>
            <div class="stats-card-icon">
              <i class="fas fa-clipboard-check"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-body stats-card info">
          <div class="stats-card-content">
            <div>
              <div class="stats-card-title">Fee Collection</div>
              <h4 class="stats-card-value" x-text="'$' + formatNumber(feeCollection)"></h4>
              <div class="small" x-show="feeGrowth > 0">
                <i class="fas fa-arrow-up text-success me-1"></i>
                <span x-text="feeGrowth + '%'"></span> since last month
              </div>
              <div class="small" x-show="feeGrowth < 0">
                <i class="fas fa-arrow-down text-danger me-1"></i>
                <span x-text="Math.abs(feeGrowth) + '%'"></span> since last month
              </div>
              <div class="small" x-show="feeGrowth === 0">
                <i class="fas fa-equals text-muted me-1"></i>
                No change since last month
              </div>
            </div>
            <div class="stats-card-icon">
              <i class="fas fa-money-bill-wave"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card h-100">
        <div class="card-body stats-card warning">
          <div class="stats-card-content">
            <div>
              <div class="stats-card-title">Upcoming Events</div>
              <h4 class="stats-card-value" x-text="upcomingEvents"></h4>
              <div class="small">
                In the next 7 days
              </div>
            </div>
            <div class="stats-card-icon">
              <i class="fas fa-calendar-alt"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts and Tables -->
  <div class="row">
    <!-- Attendance Chart -->
    <div class="col-lg-8 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title">Attendance Overview</h5>
          <div class="card-actions">
            <select class="form-select form-select-sm" x-model="attendanceFilter" @change="updateAttendanceChart">
              <option value="week">Past 7 Days</option>
              <option value="month">Past 30 Days</option>
              <option value="year">Annual</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <div style="height: 300px;">
            <canvas id="attendanceChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Activities -->
    <div class="col-lg-4 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title">Recent Activities</h5>
          <div class="card-actions">
            <a href="{% url 'reports:activities' %}" class="btn btn-sm btn-outline-primary">
              View All
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <template x-for="activity in recentActivities" :key="activity.id">
              <div class="list-group-item">
                <div class="d-flex align-items-center">
                  <div class="activity-icon" :class="'bg-light-' + activity.type">
                    <i :class="getActivityIcon(activity.type)"></i>
                  </div>
                  <div class="ms-3">
                    <div class="mb-1" x-text="activity.title"></div>
                    <div class="small text-muted" x-text="formatTime(activity.timestamp)"></div>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="recentActivities.length === 0">
              <div class="list-group-item text-center">
                <p class="mb-0">No recent activities</p>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Fee Collection Chart -->
    <div class="col-lg-4 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title">Fee Collection</h5>
          <div class="card-actions">
            <select class="form-select form-select-sm" x-model="feeFilter" @change="updateFeeChart">
              <option value="current">Current Month</option>
              <option value="year">Current Year</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <div style="height: 240px;">
            <canvas id="feeChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Gender Distribution -->
    <div class="col-lg-4 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title">Gender Distribution</h5>
          <div class="card-actions">
            <select class="form-select form-select-sm" x-model="genderFilter" @change="updateGenderChart">
              <option value="students">Students</option>
              <option value="teachers">Teachers</option>
              <option value="all">All</option>
            </select>
          </div>
        </div>
        <div class="card-body">
          <div style="height: 240px;">
            <canvas id="genderChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Upcoming Events -->
    <div class="col-lg-4 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title">Upcoming Events</h5>
          <div class="card-actions">
            <a href="{% url 'events:calendar' %}" class="btn btn-sm btn-outline-primary">
              View Calendar
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <template x-for="event in upcomingEventsList" :key="event.id">
              <div class="list-group-item">
                <div class="d-flex">
                  <div class="event-date me-3 text-center">
                    <div class="event-month" x-text="formatEventMonth(event.start_datetime)"></div>
                    <div class="event-day" x-text="formatEventDay(event.start_datetime)"></div>
                  </div>
                  <div>
                    <h6 class="mb-1" x-text="event.title"></h6>
                    <div class="small text-muted">
                      <i class="fas fa-clock me-1"></i>
                      <span x-text="formatEventTime(event.start_datetime)"></span>
                    </div>
                    <div class="small text-muted">
                      <i class="fas fa-map-marker-alt me-1"></i>
                      <span x-text="event.location"></span>
                    </div>
                  </div>
                </div>
              </div>
            </template>
            <template x-if="upcomingEventsList.length === 0">
              <div class="list-group-item text-center">
                <p class="mb-0">No upcoming events</p>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Quick Access -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title">Quick Access</h5>
        </div>
        <div class="card-body">
          <div class="row row-cols-2 row-cols-sm-3 g-3">
            <div class="col">
              <a href="{% url 'students:list' %}" class="quick-access-card">
                <div class="quick-access-icon bg-light-primary">
                  <i class="fas fa-user-graduate text-primary"></i>
                </div>
                <h6 class="quick-access-title">Students</h6>
              </a>
            </div>
            <div class="col">
              <a href="{% url 'teachers:list' %}" class="quick-access-card">
                <div class="quick-access-icon bg-light-info">
                  <i class="fas fa-chalkboard-teacher text-info"></i>
                </div>
                <h6 class="quick-access-title">Teachers</h6>
              </a>
            </div>
            <div class="col">
              <a href="{% url 'courses:list' %}" class="quick-access-card">
                <div class="quick-access-icon bg-light-warning">
                  <i class="fas fa-book text-warning"></i>
                </div>
                <h6 class="quick-access-title">Courses</h6>
              </a>
            </div>
            <div class="col">
              <a href="{% url 'exams:list' %}" class="quick-access-card">
                <div class="quick-access-icon bg-light-danger">
                  <i class="fas fa-file-alt text-danger"></i>
                </div>
                <h6 class="quick-access-title">Exams</h6>
              </a>
            </div>
            <div class="col">
              <a href="{% url 'finance:dashboard' %}" class="quick-access-card">
                <div class="quick-access-icon bg-light-success">
                  <i class="fas fa-money-bill-wave text-success"></i>
                </div>
                <h6 class="quick-access-title">Finance</h6>
              </a>
            </div>
            <div class="col">
              <a href="{% url 'reports:dashboard' %}" class="quick-access-card">
                <div class="quick-access-icon bg-light-secondary">
                  <i class="fas fa-chart-bar text-secondary"></i>
                </div>
                <h6 class="quick-access-title">Reports</h6>
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Announcements -->
    <div class="col-lg-6 mb-4">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="card-title">Announcements</h5>
          <div class="card-actions">
            <a href="{% url 'communications:announcements' %}" class="btn btn-sm btn-outline-primary">
              View All
            </a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <template x-for="announcement in announcements" :key="announcement.id">
              <div class="list-group-item">
                <h6 class="mb-1" x-text="announcement.title"></h6>
                <p class="mb-1 announcement-content" x-text="announcement.content"></p>
                <div class="d-flex justify-content-between align-items-center">
                  <small class="text-muted"
                    x-text="'By ' + announcement.created_by + ' • ' + formatDate(announcement.created_at)"></small>
                  <button class="btn btn-sm btn-link" @click="viewAnnouncement(announcement.id)">Read More</button>
                </div>
              </div>
            </template>
            <template x-if="announcements.length === 0">
              <div class="list-group-item text-center">
                <p class="mb-0">No announcements</p>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'vendors/chart.js/chart.min.js' %}"></script>
<script src="{% static 'js/modules/charts.js' %}"></script>
<!-- <script>
  function dashboardData() {
    return {
      // Stats data
      totalStudents: {{ total_students |default: 0 }
  },
  studentGrowth: { { student_growth |default: 0 } },
  attendanceRate: { { attendance_rate |default: 0 } },
  attendanceGrowth: { { attendance_growth |default: 0 } },
  feeCollection: { { fee_collection |default: 0 } },
  feeGrowth: { { fee_growth |default: 0 } },
  upcomingEvents: { { upcoming_events_count |default: 0 } },

  // Chart data
  attendanceFilter: 'week',
    feeFilter: 'current',
      genderFilter: 'students',

        // Chart instances
        attendanceChart: null,
          feeChart: null,
            genderChart: null,

              // Lists data
              recentActivities: [],
                upcomingEventsList: [],
                  announcements: [],

                    init() {
    this.fetchRecentActivities();
    this.fetchUpcomingEvents();
    this.fetchAnnouncements();

    this.initAttendanceChart();
    this.initFeeChart();
    this.initGenderChart();
  },

  fetchRecentActivities() {
    fetch('/api/v1/activities?limit=5')
      .then(response => response.json())
      .then(data => {
        this.recentActivities = data.data;
      })
      .catch(error => console.error('Error fetching activities:', error));
  },

  fetchUpcomingEvents() {
    fetch('/api/v1/events/upcoming?days=7')
      .then(response => response.json())
      .then(data => {
        this.upcomingEventsList = data.data;
      })
      .catch(error => console.error('Error fetching events:', error));
  },

  fetchAnnouncements() {
    fetch('/api/v1/announcements?limit=3')
      .then(response => response.json())
      .then(data => {
        this.announcements = data.data;
      })
      .catch(error => console.error('Error fetching announcements:', error));
  },

  initAttendanceChart() {
    fetch(`/api/v1/dashboard/attendance-chart?period=${this.attendanceFilter}`)
      .then(response => response.json())
      .then(data => {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        this.attendanceChart = createLineChart('attendanceChart', {
          labels: data.labels,
          datasets: [
            {
              label: 'Present',
              data: data.present,
              borderColor: '#1cc88a',
              backgroundColor: 'rgba(28, 200, 138, 0.1)',
              pointBackgroundColor: '#1cc88a',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#1cc88a',
              fill: true
            },
            {
              label: 'Absent',
              data: data.absent,
              borderColor: '#e74a3b',
              backgroundColor: 'rgba(231, 74, 59, 0.1)',
              pointBackgroundColor: '#e74a3b',
              pointBorderColor: '#fff',
              pointHoverBackgroundColor: '#fff',
              pointHoverBorderColor: '#e74a3b',
              fill: true
            }
          ]
        });
      })
      .catch(error => console.error('Error fetching attendance chart data:', error));
  },

  updateAttendanceChart() {
    fetch(`/api/v1/dashboard/attendance-chart?period=${this.attendanceFilter}`)
      .then(response => response.json())
      .then(data => {
        this.attendanceChart.data.labels = data.labels;
        this.attendanceChart.data.datasets[0].data = data.present;
        this.attendanceChart.data.datasets[1].data = data.absent;
        this.attendanceChart.update();
      })
      .catch(error => console.error('Error updating attendance chart:', error));
  },

  initFeeChart() {
    fetch(`/api/v1/dashboard/fee-chart?period=${this.feeFilter}`)
      .then(response => response.json())
      .then(data => {
        this.feeChart = createDoughnutChart('feeChart', {
          labels: ['Collected', 'Outstanding', 'Overdue'],
          datasets: [{
            data: [data.collected, data.outstanding, data.overdue],
            backgroundColor: ['#1cc88a', '#f6c23e', '#e74a3b'],
            borderWidth: 0
          }]
        });
      })
      .catch(error => console.error('Error fetching fee chart data:', error));
  },

  updateFeeChart() {
    fetch(`/api/v1/dashboard/fee-chart?period=${this.feeFilter}`)
      .then(response => response.json())
      .then(data => {
        this.feeChart.data.datasets[0].data = [data.collected, data.outstanding, data.overdue];
        this.feeChart.update();
      })
      .catch(error => console.error('Error updating fee chart:', error));
  },

  initGenderChart() {
    fetch(`/api/v1/dashboard/gender-chart?type=${this.genderFilter}`)
      .then(response => response.json())
      .then(data => {
        this.genderChart = createPieChart('genderChart', {
          labels: ['Male', 'Female', 'Other'],
          datasets: [{
            data: [data.male, data.female, data.other],
            backgroundColor: ['#4e73df', '#e83e8c', '#36b9cc'],
            borderWidth: 0
          }]
        });
      })
      .catch(error => console.error('Error fetching gender chart data:', error));
  },

  updateGenderChart() {
    fetch(`/api/v1/dashboard/gender-chart?type=${this.genderFilter}`)
      .then(response => response.json())
      .then(data => {
        this.genderChart.data.datasets[0].data = [data.male, data.female, data.other];
        this.genderChart.update();
      })
      .catch(error => console.error('Error updating gender chart:', error));
  },

  getActivityIcon(type) {
    const icons = {
      'login': 'fas fa-sign-in-alt text-info',
      'student': 'fas fa-user-graduate text-primary',
      'teacher': 'fas fa-chalkboard-teacher text-success',
      'attendance': 'fas fa-clipboard-check text-warning',
      'exam': 'fas fa-file-alt text-danger',
      'fee': 'fas fa-money-bill-wave text-success',
      'system': 'fas fa-cog text-secondary'
    };
    return icons[type] || 'fas fa-bell text-primary';
  },

  formatNumber(number) {
    return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  },

  formatTime(timestamp) {
    return timeAgo(timestamp);
  },

  formatDate(dateString) {
    return formatDate(dateString);
  },

  formatEventMonth(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString(undefined, { month: 'short' });
  },

  formatEventDay(dateString) {
    const date = new Date(dateString);
    return date.getDate();
  },

  formatEventTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
  },

  viewAnnouncement(id) {
    window.location.href = `/communications/announcements/${id}/`;
  }
                                };
                            }
</script> -->

<style>
  .activity-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .event-date {
    background-color: #f8f9fc;
    border-radius: 4px;
    width: 50px;
    padding: 5px;
  }

  .event-month {
    font-size: 0.8rem;
    font-weight: 600;
    color: #5a5c69;
    text-transform: uppercase;
  }

  .event-day {
    font-size: 1.5rem;
    font-weight: 700;
    color: #4e73df;
  }

  .announcement-content {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .quick-access-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    background-color: #fff;
    border-radius: 0.5rem;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
    text-decoration: none;
    transition: all 0.3s ease;
  }

  .quick-access-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1.75rem 0 rgba(58, 59, 69, 0.2);
  }

  .quick-access-icon {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.75rem;
    font-size: 1.25rem;
  }

  .quick-access-title {
    color: #5a5c69;
    margin-bottom: 0;
    font-size: 0.9rem;
  }
</style>
{% endblock %}