<!-- students/templates/students/student_form.html -->
{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}{{ title|default:"Student Form" }}{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="{% url 'core:dashboard' %}">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="{% url 'students:student-list' %}">Students</a></li>
    <li class="breadcrumb-item active">{{ title|default:"Student Form" }}</li>
  </ol>
</nav>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0">
            <i class="fas fa-user-plus mr-2"></i>
            {{ title|default:"Student Form" }}
          </h4>
        </div>
        <div class="card-body">
          <form method="post" enctype="multipart/form-data" novalidate>
            {% csrf_token %}

            <!-- Form Errors -->
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
              <ul class="mb-0">
                {% for error in form.non_field_errors %}
                <li>{{ error }}</li>
                {% endfor %}
              </ul>
            </div>
            {% endif %}

            <!-- Personal Information Section -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-user mr-2"></i>
                  Personal Information
                </h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.first_name.id_for_label }}" class="required">
                        First Name <span class="text-danger">*</span>
                      </label>
                      {{ form.first_name|add_class:"form-control" }}
                      {% if form.first_name.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.first_name.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.last_name.id_for_label }}" class="required">
                        Last Name <span class="text-danger">*</span>
                      </label>
                      {{ form.last_name|add_class:"form-control" }}
                      {% if form.last_name.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.last_name.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.email.id_for_label }}">
                        Email Address
                        <small class="text-muted">(Optional)</small>
                      </label>
                      {{ form.email|add_class:"form-control" }}
                      {% if form.email.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.email.errors.0 }}
                      </div>
                      {% endif %}
                      <small class="form-text text-muted">
                        Email address for direct communication with student
                      </small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.phone_number.id_for_label }}">
                        Phone Number
                      </label>
                      {{ form.phone_number|add_class:"form-control" }}
                      {% if form.phone_number.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.phone_number.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.date_of_birth.id_for_label }}">
                        Date of Birth
                      </label>
                      {{ form.date_of_birth|add_class:"form-control" }}
                      {% if form.date_of_birth.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.date_of_birth.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.gender.id_for_label }}">
                        Gender
                      </label>
                      {{ form.gender|add_class:"form-control" }}
                      {% if form.gender.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.gender.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label for="{{ form.profile_picture.id_for_label }}">
                        Profile Picture
                      </label>
                      {{ form.profile_picture|add_class:"form-control-file" }}
                      {% if form.profile_picture.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.profile_picture.errors.0 }}
                      </div>
                      {% endif %}
                      <small class="form-text text-muted">
                        Recommended size: 300x300 pixels
                      </small>
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="{{ form.address.id_for_label }}">
                    Address
                  </label>
                  {{ form.address|add_class:"form-control" }}
                  {% if form.address.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.address.errors.0 }}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Academic Information Section -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-graduation-cap mr-2"></i>
                  Academic Information
                </h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.admission_number.id_for_label }}" class="required">
                        Admission Number <span class="text-danger">*</span>
                      </label>
                      {{ form.admission_number|add_class:"form-control" }}
                      {% if form.admission_number.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.admission_number.errors.0 }}
                      </div>
                      {% endif %}
                      <small class="form-text text-muted">
                        Format: STU-2024-ABC123
                      </small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.admission_date.id_for_label }}" class="required">
                        Admission Date <span class="text-danger">*</span>
                      </label>
                      {{ form.admission_date|add_class:"form-control" }}
                      {% if form.admission_date.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.admission_date.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.current_class.id_for_label }}">
                        Current Class
                      </label>
                      {{ form.current_class|add_class:"form-control" }}
                      {% if form.current_class.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.current_class.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.roll_number.id_for_label }}">
                        Roll Number
                      </label>
                      {{ form.roll_number|add_class:"form-control" }}
                      {% if form.roll_number.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.roll_number.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.previous_school.id_for_label }}">
                        Previous School
                      </label>
                      {{ form.previous_school|add_class:"form-control" }}
                      {% if form.previous_school.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.previous_school.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.transfer_certificate_number.id_for_label }}">
                        Transfer Certificate Number
                      </label>
                      {{ form.transfer_certificate_number|add_class:"form-control" }}
                      {% if form.transfer_certificate_number.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.transfer_certificate_number.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Health & Emergency Information Section -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="mb-0">
                  <i class="fas fa-heart mr-2"></i>
                  Health & Emergency Information
                </h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.blood_group.id_for_label }}">
                        Blood Group
                      </label>
                      {{ form.blood_group|add_class:"form-control" }}
                      {% if form.blood_group.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.blood_group.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.status.id_for_label }}">
                        Status
                      </label>
                      {{ form.status|add_class:"form-control" }}
                      {% if form.status.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.status.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="{{ form.medical_conditions.id_for_label }}">
                    Medical Conditions / Allergies
                  </label>
                  {{ form.medical_conditions|add_class:"form-control" }}
                  {% if form.medical_conditions.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.medical_conditions.errors.0 }}
                  </div>
                  {% endif %}
                  <small class="form-text text-muted">
                    Please list any medical conditions, allergies, or special needs
                  </small>
                </div>

                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.emergency_contact_name.id_for_label }}" class="required">
                        Emergency Contact Name <span class="text-danger">*</span>
                      </label>
                      {{ form.emergency_contact_name|add_class:"form-control" }}
                      {% if form.emergency_contact_name.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.emergency_contact_name.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label for="{{ form.emergency_contact_number.id_for_label }}" class="required">
                        Emergency Contact Number <span class="text-danger">*</span>
                      </label>
                      {{ form.emergency_contact_number|add_class:"form-control" }}
                      {% if form.emergency_contact_number.errors %}
                      <div class="invalid-feedback d-block">
                        {{ form.emergency_contact_number.errors.0 }}
                      </div>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <label for="{{ form.emergency_contact_relationship.id_for_label }}">
                    Emergency Contact Relationship
                  </label>
                  {{ form.emergency_contact_relationship|add_class:"form-control" }}
                  {% if form.emergency_contact_relationship.errors %}
                  <div class="invalid-feedback d-block">
                    {{ form.emergency_contact_relationship.errors.0 }}
                  </div>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Form Actions -->
            <div class="card">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-12">
                    <div class="d-flex justify-content-between">
                      <a href="{% url 'students:student-list' %}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left mr-1"></i>
                        Cancel
                      </a>
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save mr-1"></i>
                        {{ button_label|default:"Save Student" }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Important Note Alert -->
<div class="mt-4">
  <div class="alert alert-info">
    <h6><i class="fas fa-info-circle mr-2"></i>Important Note</h6>
    <p class="mb-0">
      Students do not have login accounts in this system. All student information is managed
      by parents, teachers, and administrators. Parents can view their children's information
      through their own parent accounts.
    </p>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  $(document).ready(function () {
    // Form validation feedback
    $('form').on('submit', function (e) {
      let isValid = true;

      // Check required fields
      $('input[required], select[required]').each(function () {
        if (!$(this).val()) {
          $(this).addClass('is-invalid');
          isValid = false;
        } else {
          $(this).removeClass('is-invalid');
        }
      });

      // Validate email format if provided
      const email = $('#id_email').val();
      if (email && !isValidEmail(email)) {
        $('#id_email').addClass('is-invalid');
        isValid = false;
      }

      // Validate admission number format
      const admissionNumber = $('#id_admission_number').val();
      if (admissionNumber && !isValidAdmissionNumber(admissionNumber)) {
        $('#id_admission_number').addClass('is-invalid');
        isValid = false;
      }

      if (!isValid) {
        e.preventDefault();
        $('html, body').animate({
          scrollTop: $('.is-invalid').first().offset().top - 100
        }, 500);
      }
    });

    // Real-time validation for admission number
    $('#id_admission_number').on('input', function () {
      const value = $(this).val().toUpperCase();
      $(this).val(value);

      if (value && !isValidAdmissionNumber(value)) {
        $(this).addClass('is-invalid');
      } else {
        $(this).removeClass('is-invalid');
      }
    });

    // Real-time validation for email
    $('#id_email').on('input', function () {
      const value = $(this).val();
      if (value && !isValidEmail(value)) {
        $(this).addClass('is-invalid');
      } else {
        $(this).removeClass('is-invalid');
      }
    });

    // Profile picture preview
    $('#id_profile_picture').on('change', function () {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          // Show preview if needed
          console.log('Profile picture selected:', file.name);
        };
        reader.readAsDataURL(file);
      }
    });
  });

  function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
  }

  function isValidAdmissionNumber(admissionNumber) {
    // Basic pattern validation for admission number
    const patterns = [
      /^[A-Z]{2,5}-\d{4}-[A-Z0-9]{4,8}(-\d{2})?$/,
      /^[A-Z]{2,5}\d{4}[A-Z0-9]{4,8}$/,
      /^\d{4}[A-Z0-9]{4,8}$/,
      /^\d{7,12}$/,
      /^[A-Z]{2,5}\/\d{4}\/\d{3,6}$/
    ];

    return patterns.some(pattern => pattern.test(admissionNumber));
  }
</script>
{% endblock %}