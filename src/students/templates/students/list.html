{% extends 'dashboard_base.html' %}

{% block title %}Students | School Management System{% endblock %}

{% block page_title %}Students{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Students</li>
{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'vendors/datatables/dataTables.bootstrap5.min.css' %}">
{% endblock %}

{% block dashboard_content %}
<div class="card" x-data="studentsList()">
  <div class="card-header">
    <h5 class="card-title mb-0">Students List</h5>
    <div class="card-actions">
      <div class="btn-group">
        <button class="btn btn-outline-secondary" @click="exportCsv">
          <i class="fas fa-download me-2"></i> Export CSV
        </button>
        <button class="btn btn-outline-secondary" @click="printList">
          <i class="fas fa-print me-2"></i> Print
        </button>
        {% if user.has_perm('students.add_student') %}
        <a href="{% url 'students:create' %}" class="btn btn-primary">
          <i class="fas fa-plus me-2"></i> Add Student
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="card-body">
    <div class="filter-container mb-4">
      <div class="row g-3">
        <div class="col-md-3">
          <label for="class-filter" class="form-label">Class</label>
          <select id="class-filter" class="form-select" x-model="filters.class">
            <option value="">All Classes</option>
            {% for class in classes %}
            <option value="{{ class.id }}">{{ class.grade.name }} {{ class.section.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3">
          <label for="status-filter" class="form-label">Status</label>
          <select id="status-filter" class="form-select" x-model="filters.status">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="graduated">Graduated</option>
          </select>
        </div>
        <div class="col-md-4">
          <label for="search-filter" class="form-label">Search</label>
          <input type="text" id="search-filter" class="form-control" placeholder="Search by name, ID, etc."
            x-model="filters.search">
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button class="btn btn-secondary w-100" @click="applyFilters">
            <i class="fas fa-filter me-2"></i> Filter
          </button>
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table id="students-table" class="table table-striped table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Class</th>
            <th>Gender</th>
            <th>Admission Date</th>
            <th>Contact</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for student in students %}
          <tr>
            <td>{{ student.admission_number }}</td>
            <td>
              <div class="d-flex align-items-center">
                <img src="{{ student.user.profile_picture.url|default:'static/images/default-avatar.png' }}"
                  alt="{{ student.user.get_full_name }}" class="table-avatar me-2">
                <div>
                  <div class="fw-bold">{{ student.user.get_full_name }}</div>
                  <div class="small text-muted">{{ student.user.email }}</div>
                </div>
              </div>
            </td>
            <td>{{ student.current_class.grade.name }} {{ student.current_class.section.name }}</td>
            <td>{{ student.user.get_gender_display }}</td>
            <td>{{ student.admission_date|date:"d M Y" }}</td>
            <td>{{ student.user.phone_number }}</td>
            <td>
              <span class="badge bg-{{ student.get_status_badge }}">{{ student.get_status_display }}</span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <a href="{% url 'students:detail' student.id %}" class="btn btn-outline-primary" title="View">
                  <i class="fas fa-eye"></i>
                </a>
                {% if user.has_perm('students.change_student') %}
                <a href="{% url 'students:update' student.id %}" class="btn btn-outline-secondary" title="Edit">
                  <i class="fas fa-edit"></i>
                </a>
                {% endif %}
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown"
                    aria-expanded="false">
                    <i class="fas fa-ellipsis-v"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <a href="{% url 'students:attendance_detail' student.id %}" class="dropdown-item">
                        <i class="fas fa-clipboard-check me-2"></i> Attendance
                      </a>
                    </li>
                    <li>
                      <a href="{% url 'exams:results' %}?student_id={{ student.id }}" class="dropdown-item">
                        <i class="fas fa-file-alt me-2"></i> Exam Results
                      </a>
                    </li>
                    <li>
                      <a href="{% url 'finance:fee_details' %}?student_id={{ student.id }}" class="dropdown-item">
                        <i class="fas fa-money-bill-wave me-2"></i> Fee Details
                      </a>
                    </li>
                    <li>
                      <hr class="dropdown-divider">
                    </li>
                    <li>
                      <a href="{% url 'students:id_card' student.id %}" class="dropdown-item">
                        <i class="fas fa-id-card me-2"></i> ID Card
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'vendors/datatables/jquery.dataTables.min.js' %}"></script>
<script src="{% static 'vendors/datatables/dataTables.bootstrap5.min.js' %}"></script>
<script src="{% static 'js/modules/dataTables.js' %}"></script>
<script>
  function studentsList() {
    return {
      dataTable: null,
      filters: {
        class: '',
        status: '',
        search: ''
      },

      init() {
        this.initializeDataTable();
      },

      initializeDataTable() {
        this.dataTable = $('#students-table').DataTable({
          responsive: true,
          pageLength: 25,
          dom: '<"table-responsive"t><"row"<"col-md-6"i><"col-md-6"p>>',
          language: {
            search: '',
            searchPlaceholder: 'Search...'
          }
        });
      },

      applyFilters() {
        fetch(`/api/v1/students?class_id=${this.filters.class}&status=${this.filters.status}&search=${this.filters.search}`)
          .then(response => response.json())
          .then(data => {
            this.dataTable.clear();

            data.data.forEach(student => {
              const actions = `
                                    <div class="btn-group btn-group-sm">
                                        <a href="/students/${student.id}/" class="btn btn-outline-primary" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        ${window.userPermissions.includes('students.change_student') ?
                  `<a href="/students/${student.id}/update/" class="btn btn-outline-secondary" title="Edit">
                                                <i class="fas fa-edit"></i>
                                            </a>` : ''
                }
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a href="/students/${student.id}/attendance/" class="dropdown-item">
                                                        <i class="fas fa-clipboard-check me-2"></i> Attendance
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="/exams/results/?student_id=${student.id}" class="dropdown-item">
                                                        <i class="fas fa-file-alt me-2"></i> Exam Results
                                                    </a>
                                                </li>
                                                <li>
                                                    <a href="/finance/fees/?student_id=${student.id}" class="dropdown-item">
                                                        <i class="fas fa-money-bill-wave me-2"></i> Fee Details
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider"></li>
                                                <li>
                                                    <a href="/students/${student.id}/id-card/" class="dropdown-item">
                                                        <i class="fas fa-id-card me-2"></i> ID Card
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                `;

              const statusBadge = `<span class="badge bg-${this.getStatusBadge(student.status)}">${student.status}</span>`;

              this.dataTable.row.add([
                student.admission_number,
                `<div class="d-flex align-items-center">
                                        <img src="${student.profile_picture || '/static/images/default-avatar.png'}" alt="${student.name}" class="table-avatar me-2">
                                        <div>
                                            <div class="fw-bold">${student.name}</div>
                                            <div class="small text-muted">${student.email}</div>
                                        </div>
                                     </div>`,
                student.class_name,
                student.gender,
                student.admission_date,
                student.phone_number,
                statusBadge,
                actions
              ]);
            });

            this.dataTable.draw();
          })
          .catch(error => {
            console.error('Error fetching students:', error);
            showAlert('danger', 'Failed to fetch students. Please try again.');
          });
      },

      getStatusBadge(status) {
        const badges = {
          'active': 'success',
          'inactive': 'warning',
          'graduated': 'info',
          'transferred': 'secondary',
          'suspended': 'danger'
        };
        return badges[status.toLowerCase()] || 'secondary';
      },

      exportCsv() {
        window.location.href = `/api/v1/students/export?format=csv&class_id=${this.filters.class}&status=${this.filters.status}&search=${this.filters.search}`;
      },

      printList() {
        const printWindow = window.open('', '_blank');

        printWindow.document.write(`
                        <html>
                            <head>
                                <title>Students List</title>
                                <link rel="stylesheet" href="/static/vendors/bootstrap/css/bootstrap.min.css">
                                <style>
                                    body { padding: 20px; }
                                    table { width: 100%; border-collapse: collapse; }
                                    th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
                                    th { background-color: #f2f2f2; }
                                    .header { margin-bottom: 20px; text-align: center; }
                                    .logo { height: 60px; margin-bottom: 10px; }
                                    @media print {
                                        .no-print { display: none; }
                                    }
                                </style>
                            </head>
                            <body>
                                <div class="header">
                                    <img src="/static/images/logo.png" alt="School Logo" class="logo">
                                    <h2>School Management System</h2>
                                    <h3>Students List</h3>
                                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                                </div>
                                <button class="btn btn-primary no-print" onclick="window.print()">Print</button>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Class</th>
                                            <th>Gender</th>
                                            <th>Admission Date</th>
                                            <th>Contact</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${Array.from(this.dataTable.rows().data()).map(row => {
          const data = row;
          return `
                                                <tr>
                                                    <td>${data[0]}</td>
                                                    <td>${this.stripHtml(data[1])}</td>
                                                    <td>${data[2]}</td>
                                                    <td>${data[3]}</td>
                                                    <td>${data[4]}</td>
                                                    <td>${data[5]}</td>
                                                    <td>${this.stripHtml(data[6])}</td>
                                                </tr>
                                            `;
        }).join('')}
                                    </tbody>
                                </table>
                                <div class="mt-3 text-center">
                                    <p>© ${new Date().getFullYear()} School Management System. All rights reserved.</p>
                                </div>
                            </body>
                        </html>
                    `);

        printWindow.document.close();
        printWindow.focus();
      },

      stripHtml(html) {
        const temp = document.createElement('div');
        temp.innerHTML = html;
        return temp.textContent || temp.innerText || '';
      }
    };
  }
</script>
{% endblock %}